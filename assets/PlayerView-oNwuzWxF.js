import{ao as L,p as T,j as e,q as G,r as u,al as z,c as A,av as _}from"./vendor-oHMUNmnm.js";import{g as F,f as q,s as H,p as k,d as K,b as V,M as X,E as S,c as I,I as M,a as P,P as R,B as E,L as Y,e as J,u as Q,h as Z,i as ee,j as v,k as te,l as B,m as re,n as ne,o as ae,q as se,r as ie,t as ce,v as oe,w as de,x as ue,y as le,z as C,A as me}from"./index-lCcCH5Ws.js";import{a as b,I as $}from"./Icons-GsTIt29C.js";import{b as D,a as pe,e as he,l as fe}from"./react-dom-fa0a8-vd.js";import"./auth-PrcDRVv8.js";import"./caption-parsing-244Azz7w.js";import"./locales-PAqV36SG.js";import"./hls-zqvr_1ex.js";import"./ietf-language-tags-rlhdl_Vr.js";function ge(t,r){return!!J().DISALLOWED_IDS.map(s=>s.split("-")).find(s=>t===s[1]&&r===s[0])}function xe(t){const{t:r}=D(),o=L(),s=T(),{error:l,value:m,loading:i}=pe(async()=>{var j;const g=F();g?await q(g):H([...k.listSources(),...k.listEmbeds()]);let c=null;try{if(!o.media)throw new Error("no media params");c=K(o.media)}catch{}if(!c)return null;if(ge(c.id,c.type))throw new Error("dmca");let h=null;try{h=await V(c.type,c.id,o.season)}catch(f){if(f.status===404)return null;throw f}if(!h)return null;let x=o.episode;if(h.meta.type===X.SERIES){let f=h.meta.seasonData.episodes.find(n=>n.id===o.episode);f||(f=h.meta.seasonData.episodes[0]),x=f.id,(o.season!==h.meta.seasonData.id||o.episode!==f.id)&&s(`/media/${o.media}/${h.meta.seasonData.id}/${f.id}`,{replace:!0})}(j=t.onGetMeta)==null||j.call(t,h,x)},[]);return l&&l.message==="dmca"?e.jsx(S,{children:e.jsxs(I,{children:[e.jsx(M,{icon:b.DRAGON,children:"Removed"}),e.jsx(P,{children:"Media has been removed"}),e.jsx(R,{children:"This media is no longer available due to a takedown notice or copyright claim."}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.metadata.failed.homeButton")})]})}):l?e.jsx(S,{children:e.jsxs(I,{children:[e.jsx(M,{icon:b.WAND,children:r("player.metadata.failed.badge")}),e.jsx(P,{children:r("player.metadata.failed.title")}),e.jsx(R,{children:r("player.metadata.failed.text")}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.metadata.failed.homeButton")})]})}):!m&&!i?e.jsx(S,{children:e.jsxs(I,{children:[e.jsx(M,{icon:b.WAND,children:r("player.metadata.notFound.badge")}),e.jsx(P,{children:r("player.metadata.notFound.title")}),e.jsx(R,{children:r("player.metadata.notFound.text")}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.metadata.notFound.homeButton")})]})}):e.jsx(S,{children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(Y,{})})})}function ye(t){const{t:r}=D(),o=Q("error"),s=G(),l=u.useMemo(()=>{const m=t.data;let i="";const g=Z();return i+=`URL - ${s.pathname}
`,i+=`API - ${g.length>0}

`,Object.values(m.sources).forEach(c=>{var h;i+=`${c.id}: ${c.status}
`,c.reason&&(i+=`${c.reason}
`),(h=c.error)!=null&&h.message&&(i+=`${c.error.name??"unknown"}: ${c.error.message}
`),c.error&&(i+=`${c.error.toString()}
`)}),i},[t,s]);return e.jsxs(S,{children:[e.jsxs(I,{children:[e.jsx(M,{icon:b.WAND,children:r("player.scraping.notFound.badge")}),e.jsx(P,{children:r("player.scraping.notFound.title")}),e.jsx(R,{children:r("player.scraping.notFound.text")}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(E,{href:"/",theme:"secondary",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.scraping.notFound.homeButton")}),e.jsx(E,{onClick:()=>o.show(),theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.scraping.notFound.detailsButton")})]})]}),l?e.jsx(ee,{id:o.id,onClose:()=>o.hide(),error:l}):null]})}function O(t){return t.type==="loading"}function je(t){const[r]=z(()=>({percentage:O(t)?t.percentage:0}),[t]);return e.jsxs("div",{className:A({"p-0.5 border-current border-[3px] rounded-full h-6 w-6 relative transition-colors":!0,"text-video-scraping-loading":t.type==="loading","text-video-scraping-noresult text-opacity-50":t.type==="waiting","text-video-scraping-error bg-video-scraping-error":t.type==="error","text-green-500 bg-green-500":t.type==="success","text-video-scraping-noresult bg-video-scraping-noresult":t.type==="noresult"}),children:[e.jsx(v,{animation:"fade",show:O(t),children:e.jsx("svg",{width:"100%",height:"100%",viewBox:"0 0 64 64",xmlns:"http://www.w3.org/2000/svg",className:"rounded-full -rotate-90",children:e.jsx(he.circle,{strokeWidth:"32",strokeDasharray:_(r.percentage,o=>`${o} 100`),r:"25%",cx:"50%",cy:"50%",fill:"transparent",stroke:"currentColor",className:"transition-[strokeDasharray]"})})}),e.jsx(v,{animation:"fade",show:t.type==="error",children:e.jsx($,{className:"absolute inset-0 flex items-center justify-center text-white",icon:b.X})}),e.jsx(v,{animation:"fade",show:t.type==="success",children:e.jsx($,{className:"absolute inset-0 flex items-center text-xs justify-center text-white",icon:b.CHECKMARK})}),e.jsx(v,{animation:"fade",show:t.type==="noresult",children:e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"h-[3px] flex-1 mx-1 rounded-full bg-background-main"})})})]})}const we={notfound:"player.scraping.items.notFound",failure:"player.scraping.items.failure",pending:"player.scraping.items.pending"},be={failure:"error",notfound:"noresult",pending:"loading",success:"success",waiting:"waiting"};function U(t){const{t:r}=D(),o=we[t.status],s=be[t.status];return e.jsxs("div",{className:"grid gap-4 grid-cols-[auto,1fr]","data-source-id":t.id,children:[e.jsx(je,{type:s,percentage:t.percentage??0}),e.jsxs("div",{children:[e.jsx("p",{className:s==="loading"?"text-white":"text-type-secondary",children:t.name}),e.jsx(v,{animation:"fade",show:!!o,children:e.jsx("p",{className:"text-[15px] mt-1",children:o?r(o):""})}),t.children]})]})}function Se(t){return e.jsx("div",{"data-source-id":t.id,className:"w-80 mb-6",children:e.jsx("div",{className:A({"!bg-opacity-100 py-6":t.hasChildren,"w-80 rounded-md px-6 bg-video-scraping-card bg-opacity-0":!0}),children:e.jsx(U,{...t})})})}function ve(){const[t,r]=u.useState({}),[o,s]=u.useState([]),[l,m]=u.useState(),i=u.useRef(null),g=u.useCallback(n=>{r(n.sourceIds.map(a=>{const d=B().find(p=>p.id===a);if(!d)throw new Error("invalid source id");return{name:d.name,id:d.id,status:"waiting",percentage:0}}).reduce((a,d)=>(a[d.id]=d,a),{})),s(n.sourceIds.map(a=>({id:a,children:[]})))},[]),c=u.useCallback(n=>{const a=i.current;r(d=>(d[n]&&(d[n].status="pending"),a&&d[a]&&(d[a].status="success"),{...d})),m(n),i.current=n},[]),h=u.useCallback(n=>{r(a=>(a[n.id]&&(a[n.id].status=n.status,a[n.id].reason=n.reason,a[n.id].error=n.error,a[n.id].percentage=n.percentage),{...a}))},[]),x=u.useCallback(n=>{r(a=>(n.embeds.forEach(d=>{const y=B().find(w=>w.id===d.embedScraperId);if(!y)throw new Error("invalid source id");const p={embedId:d.embedScraperId,name:y.name,id:d.id,status:"waiting",percentage:0};a[d.id]=p}),{...a})),s(a=>{const d=a.find(y=>y.id===n.sourceId);if(!d)throw new Error("invalid source id");return d.children=n.embeds.map(y=>y.id),[...a]})},[]),j=u.useCallback(()=>{i.current=null},[]),f=u.useCallback(n=>(n&&i.current&&r(a=>i.current?(a[i.current]&&(a[i.current].status="success"),{...a}):a),n),[]);return{initEvent:g,startEvent:c,updateEvent:h,discoverEmbedsEvent:x,startScrape:j,getResult:f,sources:t,sourceOrder:o,currentSource:l}}function Ee(){const{sources:t,sourceOrder:r,currentSource:o,updateEvent:s,discoverEmbedsEvent:l,initEvent:m,getResult:i,startEvent:g,startScrape:c}=ve();return{startScraping:u.useCallback(async x=>{const j=F();if(j){c();const n=re(j),a=await te(n.scrapeAll(x),["completed","noOutput"]);a.on("init",m),a.on("start",g),a.on("update",s),a.on("discoverEmbeds",l);const d=await a.promise();return i(d===""?null:d)}if(!k)return null;c();const f=await k.runAll({media:x,events:{init:m,start:g,update:s,discoverEmbeds:l}});return i(f)},[m,g,s,l,i,c]),sourceOrder:r,sources:t,currentSource:o}}function Ne(t,r,o,s){const[l,m]=u.useState(!1),i=u.useCallback(()=>{if(!t.current||!r.current)return;const c=[...r.current.querySelectorAll("div[data-source-id]")],h=c.findIndex(W=>W.getAttribute("data-source-id")===s),x=c[h];if(!x)return;const j=t.current.getBoundingClientRect().width,f=r.current.getBoundingClientRect().width,n=t.current.getBoundingClientRect().height,a=r.current.getBoundingClientRect().top,d=x.getBoundingClientRect().top,y=x.getBoundingClientRect().height,p=d-a,w=j/2-f/2,N=n/2-p-y/2;r.current.style.transform=`translateY(${N}px) translateX(${w}px)`,setTimeout(()=>{m(!0)},150)},[s,t,r,m]),g=u.useRef(i);return u.useEffect(()=>{i(),g.current=i},[i,o]),u.useEffect(()=>{function c(){g.current()}return window.addEventListener("resize",c),()=>{window.removeEventListener("resize",c)}},[]),l}function Ce(t){const{report:r}=ne(),{startScraping:o,sourceOrder:s,sources:l,currentSource:m}=Ee(),i=fe(),g=u.useRef(null),c=u.useRef(null),h=Ne(g,c,s,m),x=u.useRef({sourceOrder:s,sources:l});u.useEffect(()=>{x.current={sourceOrder:s,sources:l}},[s,l]);const j=u.useRef(!1);u.useEffect(()=>{j.current||(j.current=!0,(async()=>{var a,d;const n=await o(t.media);i()&&((a=t.onResult)==null||a.call(t,x.current.sources,x.current.sourceOrder),r(ae(t.media,x.current.sourceOrder,x.current.sources)),(d=t.onGetStream)==null||d.call(t,n))})())},[o,t,r,i]);let f=s.findIndex(n=>n.id===m||n.children.includes(m??""));return f===-1&&(f=s.length-1),e.jsx("div",{className:"h-full w-full relative dir-neutral:origin-top-left flex",ref:g,children:e.jsx("div",{className:A({"absolute transition-[transform,opacity] opacity-0 dir-neutral:left-0":!0,"!opacity-100":h}),ref:c,children:s.map(n=>{const a=l[n.id],d=Math.abs(s.findIndex(y=>y.id===n.id)-f);return e.jsx("div",{className:"transition-opacity duration-100",style:{opacity:Math.max(0,1-d*.3)},children:e.jsx(Se,{id:n.id,name:a.name,status:a.status,hasChildren:n.children.length>0,percentage:a.percentage,children:e.jsx("div",{className:A({"space-y-6 mt-8":n.children.length>0}),children:n.children.map(y=>{const p=l[y];return e.jsx(U,{id:y,name:p.name,status:p.status,percentage:p.percentage},y)})})})},n.id)})})})}function Ie(t){const r=t??"";if(!!!r.match(/^\d+(:\d+)*$/))return null;const s=r.split(":").map(Number).reverse(),l=s[2]??0,m=Math.min(s[1]??0,59),i=Math.min(s[0]??0,m>0?59:1/0);return l*60*60+m*60+i}function Le(){const t=T(),r=L(),[o,s]=u.useState(null),[l]=se("t"),{status:m,playMedia:i,reset:g,setScrapeNotFound:c,shouldStartFromBeginning:h,setShouldStartFromBeginning:x}=ie(),{setPlayerMeta:j,scrapeMedia:f}=ce(),n=oe(),a=JSON.stringify({media:r.media,season:r.season,episode:r.episode});u.useEffect(()=>{g()},[a,g]);const d=u.useCallback(p=>{var w,N;(p==null?void 0:p.type)==="show"?t(`/media/${r.media}/${(w=p.season)==null?void 0:w.tmdbId}/${(N=p.episode)==null?void 0:N.tmdbId}`):t(`/media/${r.media}`)},[t,r]),y=u.useCallback(p=>{if(!p)return;let w;l&&(w=Ie(l)??void 0),i(de(p),ue(p.stream.captions),p.sourceId,h?0:w),x(!1)},[i,l,h,x]);return e.jsxs(le,{backUrl:n,onMetaChange:d,children:[m===C.IDLE?e.jsx(xe,{onGetMeta:j}):null,m===C.SCRAPING&&f?e.jsx(Ce,{media:f,onResult:(p,w)=>{s({sourceOrder:w,sources:p}),c()},onGetStream:y}):null,m===C.SCRAPE_NOT_FOUND&&o?e.jsx(ye,{data:o}):null,m===C.PLAYBACK_ERROR?e.jsx(me,{}):null]})}export{Le as PlayerView,Le as default};
//# sourceMappingURL=PlayerView-oNwuzWxF.js.map
